<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="css/bootstrap.css" rel='stylesheet' type='text/css' /><!-- bootstrap css -->
    <link href="css/style_index.css" rel='stylesheet' type='text/css' /><!-- custom css -->
    <link href="css/font-awesome.min.css" rel="stylesheet"><!-- fontawesome css -->
    <link href="css/css_slider.css" type="text/css" rel="stylesheet" media="all">
    <script src="js/jquery-3.5.1.min.js"></script>
</head>
<style>
    .speed-parent{
        display: none;
        width: 400px;
        height: 30px;
        background: gray;
        border-radius: 30px;
    }
    .speed{
        border: 0px;
        border-radius: 30px;
        background: green;
        height: 30px;
        line-height: 30px;
        text-align: center;
        width: 0%;
    }
    .crawlerData,.crawlerStationData,.speedOfData,.speed-parent{
        float: left;
        margin-left: 30px;
    }
    .power{
        float: left;
        width: 100%;
    }
    .table2{
        float: left;
        width: 100%;
    }
</style>
<body>
<header>
    <div th:replace="top.html :: top"></div>
</header>
<section  class="services py-5" id="services" >

       <div class="container py-lg-5 py-3" style="height: 650px;">
           <div class="power">
               <button class="crawlerData">爬取数据</button>
               <button look="1" class="crawlerStationData" id="line">线路</button>
               <button look="2" class="crawlerStationData" id="station">站点</button>
               <button class="speedOfData">导入数据</button>
               <div class="speed-parent">
                   <div class="speed"></div>
               </div>
           </div>
           <div class="table2" style="height: 100%;overflow:scroll;overflow-x:hidden;overflow-y: hidden;">
                   <table class="table-hover table-bordered" cellpadding="0" cellspacing="0"  >
                       <tbody class="table-th"></tbody>
                       <tbody class="subwayData"></tbody>
                   </table>
           </div>

       </div>

</section>
<div th:replace="bottom.html :: bottom "></div>
</body>
<script type="text/javascript">
    $(".crawlerStationData").hide();
    $(".speedOfData").hide()
    $(".table2").hover(over,out)
    function over(){
        $(".table2").css("overflow-y","")
    }
    function out(){
        $(".table2").css("overflow-y","hidden")
    }
    var lineHtml;
    var thHtml="<tr >\n" +
        "                           <th width=\"30%\">id</th>\n" +
        "                           <th width=\"20%\">线路名</th>\n" +
        "                           <th width=\"30%\">线路全名</th>\n" +
        "                           <th width=\"5%\">城市</th>\n" +
        "                       </tr>";
    var stationHtml;
    var stationthHtml=" <tr>\n" +
        "                            <th width='30%'>id</th>\n" +
        "                            <th width='20%'>站点名</th>\n" +
        "                            <th width='20%'>英文名</th>\n" +
        "                            <th width='15%'>纬度</th>\n" +
        "                            <th width='15%'>经度</th>\n" +
        "                        </tr>";
    $(".crawlerStationData").click(function (e) {
        var val = $(e.target).attr("look");
        if (val==="1"){
            $(".table-th").html(thHtml);
            $(".subwayData").html(lineHtml);
        }else{
            $(".table-th").html(stationthHtml);
            $(".subwayData").html(stationHtml);
        }
    })
    $(".crawlerData").click(function (e) {
        var clickType;
        if ($(e.target).text()==="爬取数据") {
            clickType="getLines"
        }else {
            clickType="getStations";
        }
        $(".subwayData").html("");
        $.ajax({
            beforeSend:function(){
              $(e.target).text("爬取中...")
            },
            url:"/crawler/getSubwayData",
            data:{"type":clickType},
            method: "post",
            success:function (result) {
                var lines = result.metroLines
                var stations = result.metroStations;
                getLines(lines)
                getStations(stations);
                $("#line").text("线路("+lines.length+")")
                $("#station").text("站点("+stations.length+")")
                $(".crawlerStationData").toggle();
                $(".table-th").html(thHtml);
                $(".subwayData").html(lineHtml);
                $(".crawlerData").text("爬取数据")
                $(".speedOfData").toggle()
            }
        })
    })
    function getLines(lines) {
        for(var i=0;i<lines.length;i++){
            lineHtml+="<tr><td>"+lines[i].id+"</td><td>"+lines[i].metroName+"</td><td>"+lines[i].metroNameAll+"</td><td>"+lines[i].city.nameCn+"</td></tr>"
        }
    }
    function getStations(stations) {
        for (var i = 0;i<stations.length;i++){
            stationHtml += "<tr><td>"+stations[i].id+"</td><td>"+stations[i].name+"</td><td>"+
                stations[i].nameEn+"</td><td>"+stations[i].longitude+"</td><td>"+stations[i].latitude+"</td></tr>"
        }
    }
    var timeId;
    function findSpeed(){
        $.ajax({
            url:"/crawler/SpeedOfData",
            method: "post",
            data:[],
            success:function (result) {
                if (result>=100){
                    $(".speed").text("导入完成")
                    $(".speedOfData").toggle()
                    $(".speed-parent").fadeOut("slow")
                    clearInterval(timeId);
                }else if(result<0){
                   /* $(".speed").css({"width":"100%","background":"red"});
                    $(".speed").text("导入失败，等待用户超时")*/
                   alert("导入失败，等待用户超时")
                    $(".speedOfData").toggle()
                    $(".speed-parent").css("display","none")
                    clearInterval(timeId);
                }
                $(".speed").css({"width":result+"%","background":"green"});
            }
        })

    }
   $(".speedOfData").click(function () {
       $.ajax({
           url:"/crawler/insertData",
           method:"get"
       })
       clearInterval(timeId)
       timeId=null;
       $(".speed-parent").css("display","block");
       $(".speed").text("")
       timeId = setInterval(findSpeed,1000)
   })
</script>
</html>